<div class="reports__options sticky">

    <div class="loading" *ngIf="isLoading">
        <app-loading-spinner></app-loading-spinner>
    </div>

    <div class="reports__settings">

        <div class="reports__settings--flex">
            <div class="reports__settings--setting">
                <div class="reports__settings--text">Reports Name</div>
                <div class="reports__settings--input">
                    <input type="text" name="reportsname" id="reportsname" [(ngModel)]="report.name" class="reports__input reports__input--text">
                </div>
            </div>
            <div class="reports__settings--setting">
                <div class="reports__settings--text">Class</div>
                <div class="reports__settings--input">
                    <select name="reportsclass" id="reportsclass" class="reports__input reports__input--select"  (change)="loadGroup($event.target.value)" [disabled]="report.groupId !== ''">
                        <option value="" disabled selected></option>
                        <option value="{{ grp.id }}" *ngFor="let grp of groups; let i = index" [selected]="report.groupId === grp.id">{{grp.name}}</option>
                    </select>
                </div>
            </div>
            <div class="reports__settings--setting">
                <div class="reports__settings--text">Template</div>
                <div class="reports__settings--input">
                    <select name="reportstemplate" id="reportstemplate" class="reports__input reports__input--select" (change)="loadTemplate($event.target.value)">
                        <option value="" disabled selected></option>
                        <option value="{{ temp.id }}" *ngFor="let temp of templates; let i = index" [selected]="report.templateId === temp.id">{{temp.name}}</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="reports__database-buttons">
            <button class="reports__button" (click)="saveToDatabase()" *ngIf="!reportSaved" [disabled]="isSaving">{{ isSaving ? "Saving..." : "Save" }}</button>
            <button class="reports__button" (click)="deleteFromDatabase()" *ngIf="reportSaved">Delete Report</button>
            <button class="reports__button" (click)="updateReport()" *ngIf="reportSaved" [disabled]="!unsavedChanges || isUpdating">{{ isUpdating ? "Updating..." : "Save changes"}}</button>
            <button class="reports__button" (click)="generateReports()" [disabled]="!reportGenerationReady">{{ reportGenerationReady ? "Generate Reports" : "Need all data to generate reports"}}</button>
            <!-- <div class="reports__button">Duplicate</div> -->

        </div>
    </div>
</div>

<div class="divider-line divider-line__thin" *ngIf="showGlobals() || showVariables() || showTests()"></div>

<!-- global variables, things which are the same for each student... -->
<div class="reports__global-variables" *ngIf="showGlobals()">
    <div class="reports__variables--text">
        Global Variables 
    </div>

    <div class="reports__global-variable" *ngFor="let variable of report.globals; let i = index">
        {{ variable.identifier }}

        <input type="text" class="reports__input reports__input--text" *ngIf="variable.options.length === 0"  (blur)="assignGlobalValue(variable.identifier, $event.target.value)" (keyup.enter)="assignGlobalValue(variable.identifier, $event.target.value)" value="{{variable.value}}">
        <select class="reports__input reports__input--select" (change)="assignGlobalValue(variable.identifier, $event.target.value)" *ngIf="variable.options.length > 0 && variable.options[variable.options.length-1] !== ''">
            <option value="" [selected]="variable.value === ''" disabled></option>
            <option value="newOption">* Add new option *</option>
            <option value="{{ option }}" *ngFor="let option of variable.options; let index = index" [selected]="option === variable.value">{{ option }}</option>
        </select>
        <input type="text" class="reports__input reports__input--text" *ngIf="variable.options[variable.options.length-1] === ''"  (blur)="addGlobalOption(variable.identifier, $event.target.value)" (keyup.enter)="addGlobalOption(variable.identifier, $event.target.value)">
    </div>
</div>

<!-- variables, things that needf a value for each student -->
<div class="reports__variables" *ngIf="showVariables()">
    <div class="reports__variables--text">
        Variables
    </div>

    <div class="reports__variable">
        Gender

        <select class="reports__input reports__input--select" (change)="assignVariableColumn($event.target.value, 'Gender')">
            <option value="" disabled></option>
            <option value="Gender">* Add column *</option>
            <option value="{{ option }}" *ngFor="let option of report.keys; let index = index">{{ option }}</option>
        </select>
    </div>

    <div class="reports__variable" *ngFor="let variable of report.variables; let i = index">
        {{ variable.identifier }}

        <select class="reports__input reports__input--select" (change)="assignVariableColumn($event.target.value, variable.identifier)" [disabled]="checkVariableAssignment(variable.identifier)">
            <option value="" [selected]="variable.key === '' || variable.key === undefined" disabled></option>
            <option value="{{ variable.identifier }}">* Add column *</option>
            <option value="{{ option }}" *ngFor="let option of report.keys; let index = index" [selected]="variable.identifier === option" [selected]="option === variable.key">{{ option }}</option>
        </select>
    </div>
</div>

<!-- tests, things that look at student data and filter sentence opportunities in relation to this -->
<div class="reports__test-variables" *ngIf="showTests()">
    <div class="reports__variables--text">
        Test Variables
    </div>

    <div class="reports__variable" *ngFor="let test of report.tests; let t = index">
        <div class="reports__variable-properties">
            <div class="reports__variable-properties--name">
                {{ test.identifier }}
            </div>
            <div class="reports__variable-properties--options" *ngIf="test.settings">
                <select name="testSettingsOption" id="testSettingsOption" (change)="testSettingsChange(test.identifier, $event.target.value)">
                    <option value="" disabled selected>Select a {{ test.settings.name }}</option>
                    <option value="{{ opt.name }}" *ngFor="let opt of test.settings.options; let optId = index" [selected]="test.settings.value.name === opt.name">{{ opt.name }}</option>
                </select>
            </div>
        </div>

        <div class="reports__sub-variable" *ngFor="let subTestVariable of test.values; let s = index">
            <div class="reports__sub-variable--text">
                {{ subTestVariable.name }}

            </div>
            <select class="reports__input reports__input--select" (change)="assignTestVariableColumn($event.target.value, subTestVariable.identifier, test.identifier)" [disabled]="checkTestVariableAssignment(subTestVariable.identifier, test.identifier)">
                <option value="" selected disabled></option>
                <option value="{{ subTestVariable.identifier }}">* Add column *</option>
                <option value="{{ option }}" *ngFor="let option of report.keys; let index = index" [selected]="subTestVariable.key === option">{{ option }}</option>
            </select>
        </div>
    </div>
</div>

<div class="divider-line divider-line__thin u__margin-top--medium" *ngIf="showGlobals() || showVariables() || showTests()"></div>

<div class="reports__data">
    <!-- Data table -->
    <table class="reports__data--table" *ngIf="loadedGroup !== undefined">
        <thead>
            <tr class="reports__data--row reports__data--header">
                <td></td>
                <td class="reports__data--cell" [class.reports__data--cell--hidden]="isColumnHidden(key)" *ngFor="let key of report.keys; let i = index">
                    <div class="reports__data--cell-header--dragging" value="{{ key }}" (drop)="drop($event.target.value)" (dragover)="allowDrop($event)" *ngIf="dragging"></div>
                    <div class="reports__data--cell-header">
                        
                        <!-- the make up of the table headers -->
                        <div class="reports__data--cell-header-buttons">
                            <button class="reports__data-buttons reports__data-buttons--delete" (click)="deleteColumn(key)" *ngIf="!isColumnHidden(key)">X</button>
                            <button class="reports__data-buttons reports__data-buttons--hide" (click)="hideColumn(key)" *ngIf="!isColumnHidden(key)">&#8687;</button>
                            <button class="reports__data-buttons reports__data-buttons--populate" (click)="populateSelect(key)" *ngIf="!isColumnHidden(key)">&#10010;</button>
                            <button class="reports__data-buttons reports__data-buttons--show tooltipped" (click)="showColumn(key)" *ngIf="isColumnHidden(key)">&#8687; <div class="tooltip">{{ key }}</div></button>
                            <button class="reports__data-buttons reports__data-buttons--move" draggable="true" (click)="showColumn(key)" *ngIf="!isColumnHidden(key)" (drag)="drag($event.target.value)" value="{{ key }}">&harr;</button>
                        </div>

                        <div class="reports__data--cell-header-detail">
                                
                            <div class="reports__data--cell-header-key" *ngIf="!isColumnHidden(key)"> 


                                <div class="reports__data--prepopulate" *ngIf="populateIndex === key; else displayKey">
                                    
                                    <div class="reports__data--prepopulate-text">Prepopulate</div>
                                    Data from group:
                                    <select class="reports__input reports__input--select reports__input--table" (change)="populateDataFromKey(key, $event.target.value)">
                                        <option value="{{ grpKey }}" *ngFor="let grpKey of groupKeys">{{ grpKey }}</option>
                                    </select>
                                    Copy a column:
                                    <select class="reports__input reports__input--select reports__input--table" (change)="populateDataFromColumn(key, $event.target.value)">
                                        <option value="{{ listKey }}" *ngFor="let listKey of report.keys" [disabled]="listKey === key">{{ listKey }}</option>
                                    </select>
                                    Or set all to:
                                    <div *ngIf="testOptionsExist(key); then optionsBlock else typeBlock"></div>
                                    
                                    <ng-template #optionsBlock>
                                        <select class="reports__input reports__input--select reports__input--table" (change)="populateDataFromTextOrOption(key, $event.target.value)">
                                            <option disabled></option>
                                            <option value="{{option}}" *ngFor="let option of getTestOptions(key); let optionIndex = index">{{ option }}</option>
                                        </select>
                                    </ng-template>

                                    <ng-template #typeBlock>
                                        <input class="reports__input reports__input--text reports__input--table" (keyup.enter)="populateDataFromTextOrOption(key, $event.target.value)">
                                    </ng-template>
                                </div>

                                <ng-template #displayKey> {{ key }} </ng-template>

                                <!-- if this is a section with options, display only the options  -->
                            </div>

                            <div class="reports__data--cell-header-variables" *ngIf="populateIndex !== key">
                                <!-- what does this column relate to in the rpeort -->
                                <div class="reports__key-variable-link--flexbox">
                                    <!-- regular vairable display -->
                                    <div class="reports__key-variable-link" *ngFor="let variable of report.variables">
                                        <div class="reports__key-variable-link--link-variable" *ngIf="variable.key === key" (click)="removeVariableAssignment(variable.identifier)">
                                            {{ !isColumnHidden(key) ? variable.identifier : "*" }}
                                        </div>
                                    </div>
                                    <!-- test variable display -->
                                    <div class="reports__key-variable-link" *ngFor="let tests of report.tests">
                                        <div *ngFor="let test of tests.values">
                                            <div class="reports__key-variable-link--link-test" *ngIf="test.key === key" (click)="removeTestVariableAssignment(test.identifier, tests.identifier)">
                                                {{ !isColumnHidden(key) ? test.name : "*" }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
                <td class="reports__data--cell reports__data--report">Report</td>
            </tr>
        </thead>
        <tbody>
            <!-- user data -->
            <tr class="reports__data--row reports__data--data" *ngFor="let individual of report.reports; let reportId = index">
                <td class="reports__data--cell">
                    <div class="reports__data-buttons reports__data-buttons--delete" (click)="deleteUserReport(reportId)">X</div>
                </td>
                <td class="reports__data--cell" [class.reports__data--cell--hidden]="isColumnHidden(key)" *ngFor="let key of report.keys; let i = index">
                    <div *ngIf="!isColumnHidden(key)">
                        <!-- if this is a section with options, display only the options  -->
                        <div *ngIf="testOptionsExist(key); then optionsBlock else typeBlock"></div>
                        <ng-template #optionsBlock>
                                <select class="reports__input reports__input--select reports__input--table" (change)="valueChange2(reportId, key, $event.target.value)">
                                    <option disabled [selected]="individual.user[key] === '' || individual.user[key] === undefined"></option>
                                    <option value="{{option}}" *ngFor="let option of getTestOptions(key); let optionIndex = index" [selected]="option === individual.user[key]">{{ option }}</option>
                                </select>
                        </ng-template>
                        <ng-template #typeBlock>
                            <input class="reports__input reports__input--text reports__input--table" (keyup.enter)="valueChange2(reportId, key, $event.target.value)" (blur)="valueChange2(reportId, key, $event.target.value)" value="{{ individual.user[key] }}">
                            <!-- {{ individual.user[key] }} -->
                        </ng-template>
                    </div>
                    <div *ngIf="isColumnHidden(key)">
                        . . .
                    </div>
                </td>
                <td class="reports__data--cell reports__data--report tooltipped" (click)="copyReportText(reportId)">{{individual.report}} <div class="tooltip">Click to copy to clipboard</div></td>
            </tr>
        </tbody>
    </table>
</div>